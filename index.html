<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>JS Bin</title>
  <script src="https://cdn.bootcss.com/d3/4.8.0/d3.min.js"></script>
  <style>
    .chart {
      /*width: 400px;*/
      /*height: 400px;*/
      padding: 20px;
      border: 1px dashed purple;
    }

    .bar {
      color: #DDD;
    }

    rect:hover {
      cursor: pointer;
    }

    .text {
      fill: #FFF;
      font-size: .8rem;
      /*text-align: center;*/
    }
  </style>
  <script id="__bs_script__">
    //<![CDATA[
    document.write("<script async src='http://HOST:3000/browser-sync/browser-sync-client.js?v=2.18.8'><\/script>".replace(
      "HOST", location.hostname));
    //]]>
  </script>
</head>

<body>
  <div class="chart"></div>
</body>
<script>
  let margin = {
    left: 40,
    top: 20,
    right: 20,
    bottom: 30
  }
  var w = 400 - margin.left - margin.right,
    h = 400 - margin.top - margin.bottom;
  
  const offsetY = 10;
  var dataset = [{
    time: '2017-05-01',
    count: 42
  }, {
    time: '2017-05-02',
    count: 134
  }, {
    time: '2017-05-03',
    count: 52
  }, {
    time: '2017-05-04',
    count: 171
  }, {
    time: '2017-05-05',
    count: 52
  }, {
    time: '2017-05-06',
    count: 92
  }, {
    time: '2017-05-07',
    count: 32
  }];
  var chart = d3.select('.chart')
    .selectAll('div')
    .data(dataset);

  var item = chart.enter()
    .insert('div')
    .text(a => a.count)
    .style('color', 'white');

  chart.exit().remove();
  chart.merge(item)
    .style('width', d => d.count + 10 + 'px')
    .style('height', '20px')
    .style('margin-top', '2px')
    .style('background', '#09A')

  var svg = d3.select('.chart')
    .insert('svg')
    .attr('width', w + margin.left + margin.right)
    .attr('height', h + margin.top + margin.bottom)
    .style('margin-top', '10px')
    .style('background', '#DDD')
    .call(responsivefy);

  var max = d3.max(dataset, d => {
    return d.count;
  });

  var g = svg.selectAll('g')
    .data(dataset)
    .enter()
    .insert('g')
    .attr('width', w)
    .attr('height', h)
    .attr('transform', 'translate(' + margin.left + ', ' + margin.top + ')');
  // .attr('transform', (d, i) => 'translate(0, ' + h + ')');

  console.debug('max: ', max);
  let yScale = d3.scaleLinear()
    .domain([0, max])
    .range([h, 0]);

  let yAxis = d3.axisLeft(yScale).ticks(12);

  svg.insert('g')
    .attr('transform', `translate(${margin.left}, ${margin.top - offsetY})`)
    .call(yAxis);

  let xScale = d3.scaleBand()
    .padding(0.2)
    .domain(dataset.map(a => a.time))
    // .domain([new Date(dataset[0].time), new Date(dataset[dataset.length - 1].time)])
    // .domain([new Date(2017, 5, 1), new Date(2017, 5, 5)])
    .range([0, w]);

  let xAxis = d3.axisBottom(xScale).ticks(dataset.length);
  
  svg.insert('g')
    .attr('transform', `translate(${margin.left}, ${h + margin.top - offsetY})`)
    .call(xAxis)
    .selectAll('text')
    .attr('text-anchor', 'end')
    .attr('transform', 'rotate(-30)');

  g.insert('rect')
    .attr('x', d => xScale(d.time))
    .attr('y', d => yScale(d.count) - offsetY)
    .attr('width', d => xScale.bandwidth())
    .attr('height', d => h - yScale(d.count))
    .attr('fill', '#099')
    .attr('stroke', '#FFF')
    .on('mouseenter', function (d, i, elems) {
      d3.select(this).attr('fill', '#09F')
      // .style('transform', d => 'scaleX(2)')
      // .style('transform', d => 'translate(0, ' + d.count * 2 + ')')
    })
    .on('mouseleave', function (d, i, elems) {
      d3.select(this).attr('fill', '#099')
      // .style('transform', d => 'translate(0, ' + d.count + ')')
      // .style('transform', d => 'scaleY(1)')
    });

  g.insert('text')
    .text(d => d.count)
    .classed('text', true)
    .attr('transform', (d, i) => {
      let x = xScale(d.time);
      let y = h - 20;
      return 'translate(' + x + ', ' + y + ')';
    });

    function responsivefy(svg) {
      let container = d3.select(svg.node().parentNode),
      width = parseInt(svg.style('width')),
      height = parseInt(svg.style('height')),
      aspect = width / height;

      svg.attr('viewBox', '0 0 ' + width + ' ' + height)
      .attr('perserveAspectRatio', 'xMinyMid')
      .call(resize);

      d3.select(window).on('resize.' + container.attr('id'), resize);

      function resize() {
        let tw = parseInt(container.style('width'));
        svg.attr('width', tw);
        svg.attr('height', Math.round(tw / aspect));
      }
    }
</script>

</html>